<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <style>
        body { width: 320px; padding: 15px; font-family: 'Segoe UI', sans-serif; }
        h3 { margin-top: 0; color: #333; }
        textarea { width: 100%; height: 100px; margin-bottom: 10px; box-sizing: border-box; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        button { 
            width: 100%; padding: 12px; margin-bottom: 8px; 
            background: #4CAF50; color: white; border: none; 
            cursor: pointer; border-radius: 4px; font-size: 14px;
            transition: 0.2s;
        }
        button:hover { background: #45a049; }
        button:active { transform: scale(0.98); }
        .secondary { background: #2196F3; }
        .secondary:hover { background: #0b7dda; }
        .status { 
            font-size: 12px; 
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            display: none;
        }
        .status.error { display: block; background: #ffebee; color: #c62828; }
        .status.success { display: block; background: #e8f5e9; color: #2e7d32; }
        .status.info { display: block; background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <h3>ğŸ“ ç¿’å­—å¸–ç”¢ç”Ÿå™¨</h3>
    
    <textarea id="inputText" placeholder="åœ¨æ­¤è²¼ä¸Šè‹±æ–‡ç´”æ–‡å­—..."></textarea>
    <button id="btnFromInput">âœï¸ è½‰æ›è²¼ä¸Šçš„æ–‡å­—</button>
    
    <hr style="border: 0; border-top: 1px solid #eee; margin: 12px 0;">

    <button id="btnFromPage" class="secondary">ğŸ“„ æŠ“å–ç•¶å‰ç¶²é å…§å®¹</button>
    
    <div id="status" class="status"></div>

    <script>
        const statusEl = document.getElementById('status');
        const inputEl = document.getElementById('inputText');
        
        function showStatus(msg, type) {
            statusEl.className = 'status ' + type;
            statusEl.textContent = msg;
        }
        
        function hideStatus() {
            statusEl.className = 'status';
        }
        
        function openViewer(text) {
            if (!text || text.trim() === '') {
                showStatus('æ²’æœ‰æ–‡å­—å¯ä»¥è½‰æ›ï¼', 'error');
                return;
            }
            
            // é™åˆ¶é•·åº¦é¿å… URL éé•·
            const trimmedText = text.trim().substring(0, 8000);
            const encodedText = encodeURIComponent(trimmedText);
            const viewerUrl = chrome.runtime.getURL('viewer.html') + '?text=' + encodedText;
            
            showStatus('æ­£åœ¨é–‹å•Ÿç¿’å­—å¸–...', 'info');
            
            // ä½¿ç”¨ chrome.tabs.create é–‹å•Ÿæ–°åˆ†é 
            chrome.tabs.create({ url: viewerUrl }, (tab) => {
                if (chrome.runtime.lastError) {
                    showStatus('é–‹å•Ÿå¤±æ•—: ' + chrome.runtime.lastError.message, 'error');
                } else {
                    // æˆåŠŸå¾Œé—œé–‰ popup
                    window.close();
                }
            });
        }

        // è½‰æ›è²¼ä¸Šçš„æ–‡å­—
        document.getElementById('btnFromInput').addEventListener('click', () => {
            hideStatus();
            const text = inputEl.value;
            openViewer(text);
        });

        // æŠ“å–ç•¶å‰ç¶²é å…§å®¹
        document.getElementById('btnFromPage').addEventListener('click', () => {
            hideStatus();
            showStatus('æ­£åœ¨æŠ“å–ç¶²é å…§å®¹...', 'info');
            
            chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
                if (!tabs || tabs.length === 0) {
                    showStatus('æ‰¾ä¸åˆ°ç•¶å‰åˆ†é ', 'error');
                    return;
                }
                
                const tab = tabs[0];
                
                // æª¢æŸ¥æ˜¯å¦å¯ä»¥åœ¨æ­¤é é¢åŸ·è¡Œè…³æœ¬
                if (tab.url.startsWith('chrome://') || tab.url.startsWith('chrome-extension://') || tab.url.startsWith('about:')) {
                    showStatus('ç„¡æ³•åœ¨æ­¤é¡å‹é é¢æŠ“å–å…§å®¹', 'error');
                    return;
                }
                
                chrome.scripting.executeScript({
                    target: { tabId: tab.id },
                    func: () => {
                        return document.body.innerText || document.body.textContent || '';
                    }
                }, (results) => {
                    if (chrome.runtime.lastError) {
                        showStatus('æŠ“å–å¤±æ•—: ' + chrome.runtime.lastError.message, 'error');
                        return;
                    }
                    
                    if (results && results[0] && results[0].result) {
                        const pageText = results[0].result;
                        const cleanText = pageText.replace(/\s+/g, ' ').trim();
                        
                        if (cleanText.length < 5) {
                            showStatus('ç¶²é å…§å®¹å¤ªå°‘æˆ–ç‚ºç©º', 'error');
                            return;
                        }
                        
                        openViewer(cleanText);
                    } else {
                        showStatus('ç„¡æ³•å–å¾—ç¶²é å…§å®¹', 'error');
                    }
                });
            });
        });
    </script>
</body>
</html>